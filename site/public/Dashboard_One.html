<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Projeto IoT - Tempo Real</title>
    <link rel="stylesheet" href="css/dashboards.css">

    <!-- script do google charts -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
	<!-- <script type="text/javascript" src="funcoes.js"></script> -->
	
	<script type="text/javascript" src="https://www.chartjs.org/dist/2.8.0/Chart.min.js"></script>
    <script type="text/javascript" src="https://www.chartjs.org/samples/latest/utils.js"></script>
    <script type="text/javascript" src="funcoes.js"></script>
    <style>
		canvas {
			-moz-user-select: none;
			-webkit-user-select: none;
			-ms-user-select: none;
		}
	</style>
	<link rel="stylesheet" href="./assets/css/header.css">
	<link rel="stylesheet" href="./assets/css/footer.css">
	<link rel="stylesheet" href="./assets/css/api.css">
	<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@300&display=swap" rel="stylesheet">
	<link rel="shortcut icon" href="./assets/img/favicon.ico" type="image/x-icon">
</head>
<body onload="atualizacaoPeriodica()" class="body" >
    <!--header inicio-->
    <img class="imgFundo" src="./assets/img/background.png">
	<header class="header">
		<div class="header-box">
			<a href="home.html">
				<img class="header-box-img" src="./assets/img/logoOne.png" alt="logo">
			</a>
		</div>
		<ul class="header-ul">
			<a href="grafico-chartjs.html"><li class="header-ul-li">Gráfico de histórico recente</li></a>
			<a href="sobre.html"><li class="header-ul-li">sobre</li></a>
			<a href="contato.html"><li class="header-ul-li">contato</li></a>
            <a href="login.html" onclick="logoff()"><li class="header-ul-li">LOGOUT</li></a>
		</ul>
	</header>
    <!--header fim-->
    <div class="dashboard">
        <div class="container">
            <div class="caminhao">
                <h4>Caminhão <span name="namecaminhao" id="idcaminhao" value="1">1</span></h4>
                <div class="valores">
                    <div class="valor" id="div_temperatura">Temperatura sendo obtida...</div>
                    <div class="valor" id="div_umidade">Umidade sendo obtida...</div>
                </div>
                <div class="alertas">
                    <div class="alerta" id="div_alerta_temperatura"> </div>
                    <div class="alerta_umidd" id="div_alerta_umidade"></div>
                </div>
            </div>
            <div class="caminhao">
                <h4>Caminhão <span name="namecaminhao" id="idcaminhao" value="2">2</span></h4>
                <div class="valores">
                    <div class="valor" id="div_temperatura2">Temperatura sendo obtida...</div>
                    <div class="valor" id="div_umidade2">Umidade sendo obtida...</div>
                </div>
                <div class="alertas">
                    <div class="alerta" id="div_alerta_temperatura2"></div>
                    <div class="alerta_umidd" id="div_alerta_umidade2"></div>
                </div>
            </div>
		</div>
    </div>
    <section class="main">
		<div id="sidenav" class="sidenav">
			<img class="sidenav-closeImg" onclick="toggleNav()" src="./assets/img/close.svg">
			<div class="sidenav-icons">
				<div class="sidenav-analytics">
					<img class="analytics-icon" onclick="showAnalytics()" src="./assets/img/analytics.svg">
					<p class="analytics-text">Analytics</p>
				</div>
				<div class="sidenav-histo">
					<img class="histo-icon" onclick="showHist()" src="./assets/img/history.svg">
					<p class="histo-text">Histórico</p>
				</div>
			</div>
			<!-- <button class="sidenav-item" onclick="showAnalytics()">Analytics</button> -->
			<button class="sidenav-item">Primeiro andar</button>
			<button class="sidenav-item">Saguão</button>
			<button class="sidenav-item">Terreo</button>
			<button class="sidenav-item">Subsolo</button>
		</div>
		<span class="openbtn" style="font-size:30px;cursor:pointer;color:white" onclick="toggleNav()">&#9776; ver
			mais</span>
		<div class="main-box">
			<div class="analytics" id="analytics">
				<img class="analytics-img" src="./assets/img/analyticsTemp.PNG">
				<img class="analytics-img" src="./assets/img/analyticsUmid.PNG">
			</div>
	<div class="hist" id="hist">
		<img class="sidenav-closeImg" onclick="showHist()" src="./assets/img/close.svg">
		<div class="hist-nav">
			<button>primeiro andar</button>
			<button>terreo</button>
			<button>subsolo</button>
		</div>
		<div class="hist-box">
			<div class="hist-top">
				<p class="hist-temp-title">hora</p>
				<p class="hist-temp-title">temp</p>
				<p class="hist-temp-title">umid</p>
			</div>
			<div class="hist-temp">
				<p class="hist-temp-value" id="histHour"></p>
				<p class="hist-temp-value" id="histTemp"></p>
				<p class="hist-temp-value" id="histUmid"></p>
			</div>
		</div>
		<!-- <div class="hist-umid"></div> -->
	</div>


			<div style="display: flex;justify-content: space-evenly">
				<div style="width: 540px; height: 245px">
					<canvas id="grafico_umid"></canvas>
				</div>
				<div style="width: 540px; height: 245px">
					<canvas id="grafico_temp"></canvas>
				</div>
			</div>
		</div>
	</section>
	<img class="imgChatbot" src="./assets/img/help.svg" onclick="toggleChatbot()" alt="icone">
	<div class="chatbot" id="chatbot">
		<h3 class="chatbot-title">bem vindo ao suporte</h3>
		<p class="chatbot-text">Tire as suas dúvidas nos nossos tópicos abaixo</p>
		<button class="mostrarQuestoes" onclick="mostrarOpcoes()">Dúvidas Frequentes</button>
		<img class="sidenav-closeImg" onclick="toggleChatbot()" src="./assets/img/close.svg">
		<div id="questoes" class="chatbot-quest">
			<span class="chatbot-quest-item" onclick="sensorParou()">sensor parou</span>
			<span class="chatbot-quest-item" onclick="sensorExplodiu()">sensor explodiu</span>
			<span class="chatbot-quest-item" onclick="socorroMeAjuda()">socorro me ajuda</span>
		</div>
	</div>
	<div class="chatbotResp" id="chatbotResp">
		<h3 id="respTitle" class="resp-title"></h3>
		<p id="respItem1" class="resp-item"></p>
		<p id="respItem2" class="resp-item"></p>
		<p id="respItem3" class="resp-item"></p>
		<p id="respItem4" class="resp-item"></p>
		<p id="respItem5" class="resp-item"></p>
		<img class="sidenav-closeImg" onclick="sensorParou()" src="./assets/img/close.svg">
	</div>

	</div>

    <footer class="footer-api">
		<p class="footer-text"> One - solutions</p>
		<div class="footer-box">
			<img class="footer-box-img" src="./assets/img/github-logo.svg" alt="" class="footer-box">
			<img class="footer-box-img" src="./assets/img/facebook-circular-logo.svg" alt="" class="footer-box">
		</div>
	</footer>
</body>


<script>
    function toggleNav() {
		document.getElementById("sidenav").classList.toggle('open')
	}
	function toggleChatbot() {
		document.getElementById('chatbot').classList.toggle('ativar')
	}
	function showAnalytics() {
		document.getElementById('analytics').classList.toggle('ativar')
	}
	function showHist() {
		document.getElementById('hist').classList.toggle('ativar')
	}
	function mostrarOpcoes() {
		document.getElementById('questoes').classList.toggle('activeQuests')
	}
	function sensorParou() {
		document.getElementById('chatbotResp').classList.toggle('ativar')
		document.getElementById('respTitle').innerHTML = 'O sensor parou'
		document.getElementById('respItem1').innerHTML = '1° Verifique se o aparelho está ligado na tomada'
		document.getElementById('respItem2').innerHTML = '2° Verifique se o aparelho está conectado com a internet'
		document.getElementById('respItem3').innerHTML = '3° Verifique se o aparelho uahsuai asuahas'
		document.getElementById('respItem4').innerHTML = '4° Verifique se o aparelho uahsuai asuahas'
		document.getElementById('respItem5').innerHTML = '5° Verifique se o aparelho uahsuai asuahas'
	}
	function sensorExplodiu() {
		document.getElementById('chatbotResp').classList.toggle('ativar')
		document.getElementById('respTitle').innerHTML = 'O sensor explodiu'
		document.getElementById('respItem1').innerHTML = '1° hsasjda oapspdasd aoswqpd'
		document.getElementById('respItem2').innerHTML = '2° ashuuaios joiasoijas jopsd '
		document.getElementById('respItem3').innerHTML = '3° uaasd hsuu ahas'
		document.getElementById('respItem4').innerHTML = '4° gswi asuaswhas'
		document.getElementById('respItem5').innerHTML = '5° asfdge'
	}
	function socorroMeAjuda() {
		document.getElementById('chatbotResp').classList.toggle('ativar')
		document.getElementById('respTitle').innerHTML = 'Socorro me ajuda'
		document.getElementById('respItem1').innerHTML = '1° batata'
		document.getElementById('respItem2').innerHTML = '2° batata asias '
		document.getElementById('respItem3').innerHTML = '3° ksçapsd dasda'
		document.getElementById('respItem4').innerHTML = '4° kasopçj apssasds'
		document.getElementById('respItem5').innerHTML = '5° fjk´pçspw wwwws'
	}

	let usuario;
	



    // verificar_autenticacao();

    // só mexer se quiser alterar o tempo de atualização
    // ou se souber o que está fazendo!
    function atualizacaoPeriodica() {
		// sendData()
		obterdadosporcaminhao(1);
        obterdadosporcaminhao(2);
		
		setTimeout(atualizacaoPeriodica, 5000);
    }


    function obterdadosporcaminhao(idcaminhao) {
        //aguardar();
        fetch(`/leituras/dashboard_one/${idcaminhao}`)
        .then(resposta => {

            if (resposta.ok) {
                resposta.json().then(function (resposta) {

                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);

                    // aqui, após registro. use os nomes 
                    // dos atributos que vem no JSON 
                    var dados = {
                        temperatura: resposta.temperatura,
                        umidade: resposta.umidade
                    }

                    alertar(resposta.temperatura, resposta.umidade, idcaminhao);
                    atualizarTela(dados, idcaminhao);
                });
            } else {

                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
        .catch(function (error) {
                console.error(`Erro na obtenção dos dados do caminhao p/ gráfico: ${error.message}`);
            });
    }

    function alertar(temperatura, umidade, idcaminhao) {
        // padrão para meu alerta
        var limites = {
            max_temperatura: 40,
            min_temperatura: 20,
            max_umidade: 80,
            min_umidade: 50,
        };

        // zerar aviso de mensagem
        var mensagem_temperatura = '';
        var mensagem_umidade = '';
        var classe_temperatura = 'alerta';
        var classe_umidade = 'alerta_umidd';

        // comparando
        if (temperatura > limites.max_temperatura) {
            mensagem_temperatura += 'Temperatura alta demais! <br>';
            classe_temperatura = 'alerta alerta-alto';
        }
        if (umidade > limites.max_umidade) {
            mensagem_umidade += 'Umidade alta demais! <br>';
            classe_umidade = 'alerta_umidd alerta-alto';
        }
        if (temperatura < limites.min_temperatura) {
            mensagem_temperatura = 'Temperatura baixa demais! <br>';
            classe_temperatura = 'alerta alerta-baixo';
        }
        if (umidade < limites.min_umidade) {
            mensagem_umidade = 'Umidade baixa demais! <br>';
            classe_umidade = 'alerta_umidd alerta-baixo';
        }

        // escolhendo qual alterar
        var div_temperatura_alterar
        var div_umidade_alterar

        if (idcaminhao == 1) {
            div_temperatura_alterar = div_alerta_temperatura
            div_umidade_alterar = div_alerta_umidade
		} 
		else if (idcaminhao == 2) {
            div_temperatura_alterar = div_alerta_temperatura2
            div_umidade_alterar = div_alerta_umidade2
        }

        // alterando
        div_temperatura_alterar.innerHTML = mensagem_temperatura;
        div_temperatura_alterar.className = classe_temperatura;

        div_umidade_alterar.innerHTML = mensagem_umidade;
        div_umidade_alterar.className = classe_umidade;
    }

    // só altere aqui se souber o que está fazendo!
    function atualizarTela(dados, idcaminhao) {
        console.log('iniciando atualização da tela...');

        // escolhendo qual alterar
        var div_temperatura_alterar
        var div_umidade_alterar

        if (idcaminhao == 1) {
            div_temperatura_alterar = div_temperatura
            div_umidade_alterar = div_umidade
		} 
		else if (idcaminhao == 2) {
            div_temperatura_alterar = div_temperatura2
            div_umidade_alterar = div_umidade2
        }

        div_temperatura_alterar.innerHTML = `Temperatura: ${dados.temperatura}º`;

        div_umidade_alterar.innerHTML = `Umidade: ${dados.umidade}%`;

    }


    function sendData() {
        // setInterval(() => {
			var http = new XMLHttpRequest();
			http.open('GET', 'http://localhost:9000/api/sendData', false);
			http.send(null);
		// }, 5000);
    }
	// window.onload = sendData();
    setInterval(() => {
		sendData();
    }, 2000);
</script>
